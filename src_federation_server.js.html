<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/federation_server.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Account.html">Account</a><ul class='methods'><li data-type='method'><a href="Account.html#.isValidAccountId">isValidAccountId</a></li><li data-type='method'><a href="Account.html#accountId">accountId</a></li><li data-type='method'><a href="Account.html#incrementSequenceNumber">incrementSequenceNumber</a></li><li data-type='method'><a href="Account.html#sequenceNumber">sequenceNumber</a></li></ul></li><li><a href="AccountCallBuilder.html">AccountCallBuilder</a><ul class='methods'><li data-type='method'><a href="AccountCallBuilder.html#accountId">accountId</a></li><li data-type='method'><a href="AccountCallBuilder.html#address">address</a></li><li data-type='method'><a href="AccountCallBuilder.html#call">call</a></li><li data-type='method'><a href="AccountCallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="AccountCallBuilder.html#limit">limit</a></li><li data-type='method'><a href="AccountCallBuilder.html#order">order</a></li><li data-type='method'><a href="AccountCallBuilder.html#stream">stream</a></li></ul></li><li><a href="Asset.html">Asset</a><ul class='methods'><li data-type='method'><a href="Asset.html#.fromOperation">fromOperation</a></li><li data-type='method'><a href="Asset.html#.native">native</a></li><li data-type='method'><a href="Asset.html#equals">equals</a></li><li data-type='method'><a href="Asset.html#getAssetType">getAssetType</a></li><li data-type='method'><a href="Asset.html#getCode">getCode</a></li><li data-type='method'><a href="Asset.html#getIssuer">getIssuer</a></li><li data-type='method'><a href="Asset.html#isNative">isNative</a></li><li data-type='method'><a href="Asset.html#toXdrObject">toXdrObject</a></li></ul></li><li><a href="CallBuilder.html">CallBuilder</a><ul class='methods'><li data-type='method'><a href="CallBuilder.html#call">call</a></li><li data-type='method'><a href="CallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="CallBuilder.html#limit">limit</a></li><li data-type='method'><a href="CallBuilder.html#order">order</a></li><li data-type='method'><a href="CallBuilder.html#stream">stream</a></li></ul></li><li><a href="EffectCallBuilder.html">EffectCallBuilder</a><ul class='methods'><li data-type='method'><a href="EffectCallBuilder.html#call">call</a></li><li data-type='method'><a href="EffectCallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="EffectCallBuilder.html#forAccount">forAccount</a></li><li data-type='method'><a href="EffectCallBuilder.html#forLedger">forLedger</a></li><li data-type='method'><a href="EffectCallBuilder.html#forOperation">forOperation</a></li><li data-type='method'><a href="EffectCallBuilder.html#forTransaction">forTransaction</a></li><li data-type='method'><a href="EffectCallBuilder.html#limit">limit</a></li><li data-type='method'><a href="EffectCallBuilder.html#order">order</a></li><li data-type='method'><a href="EffectCallBuilder.html#stream">stream</a></li></ul></li><li><a href="FederationServer.html">FederationServer</a><ul class='methods'><li data-type='method'><a href="FederationServer.html#.createForDomain">createForDomain</a></li><li data-type='method'><a href="FederationServer.html#.resolve">resolve</a></li><li data-type='method'><a href="FederationServer.html#resolveAccountId">resolveAccountId</a></li><li data-type='method'><a href="FederationServer.html#resolveAddress">resolveAddress</a></li><li data-type='method'><a href="FederationServer.html#resolveTransactionId">resolveTransactionId</a></li></ul></li><li><a href="Keypair.html">Keypair</a><ul class='methods'><li data-type='method'><a href="Keypair.html#.fromAccountId">fromAccountId</a></li><li data-type='method'><a href="Keypair.html#.fromBase58Seed">fromBase58Seed</a></li><li data-type='method'><a href="Keypair.html#.fromRawSeed">fromRawSeed</a></li><li data-type='method'><a href="Keypair.html#.fromSeed">fromSeed</a></li><li data-type='method'><a href="Keypair.html#.master">master</a></li><li data-type='method'><a href="Keypair.html#.random">random</a></li><li data-type='method'><a href="Keypair.html#accountId">accountId</a></li><li data-type='method'><a href="Keypair.html#canSign">canSign</a></li><li data-type='method'><a href="Keypair.html#rawPublicKey">rawPublicKey</a></li><li data-type='method'><a href="Keypair.html#rawSecretKey">rawSecretKey</a></li><li data-type='method'><a href="Keypair.html#rawSeed">rawSeed</a></li><li data-type='method'><a href="Keypair.html#seed">seed</a></li><li data-type='method'><a href="Keypair.html#sign">sign</a></li><li data-type='method'><a href="Keypair.html#verify">verify</a></li></ul></li><li><a href="LedgerCallBuilder.html">LedgerCallBuilder</a><ul class='methods'><li data-type='method'><a href="LedgerCallBuilder.html#call">call</a></li><li data-type='method'><a href="LedgerCallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="LedgerCallBuilder.html#ledger">ledger</a></li><li data-type='method'><a href="LedgerCallBuilder.html#limit">limit</a></li><li data-type='method'><a href="LedgerCallBuilder.html#order">order</a></li><li data-type='method'><a href="LedgerCallBuilder.html#stream">stream</a></li></ul></li><li><a href="Memo.html">Memo</a><ul class='methods'><li data-type='method'><a href="Memo.html#.hash">hash</a></li><li data-type='method'><a href="Memo.html#.id">id</a></li><li data-type='method'><a href="Memo.html#.none">none</a></li><li data-type='method'><a href="Memo.html#.returnHash">returnHash</a></li><li data-type='method'><a href="Memo.html#.text">text</a></li></ul></li><li><a href="Network.html">Network</a><ul class='methods'><li data-type='method'><a href="Network.html#.current">current</a></li><li data-type='method'><a href="Network.html#.use">use</a></li><li data-type='method'><a href="Network.html#.useDefault">useDefault</a></li><li data-type='method'><a href="Network.html#.usePublicNetwork">usePublicNetwork</a></li><li data-type='method'><a href="Network.html#.useTestNetwork">useTestNetwork</a></li><li data-type='method'><a href="Network.html#networkId">networkId</a></li><li data-type='method'><a href="Network.html#networkPassphrase">networkPassphrase</a></li></ul></li><li><a href="OfferCallBuilder.html">OfferCallBuilder</a></li><li><a href="Operation.html">Operation</a><ul class='methods'><li data-type='method'><a href="Operation.html#.accountMerge">accountMerge</a></li><li data-type='method'><a href="Operation.html#.allowTrust">allowTrust</a></li><li data-type='method'><a href="Operation.html#.changeTrust">changeTrust</a></li><li data-type='method'><a href="Operation.html#.createAccount">createAccount</a></li><li data-type='method'><a href="Operation.html#.createPassiveOffer">createPassiveOffer</a></li><li data-type='method'><a href="Operation.html#.inflation">inflation</a></li><li data-type='method'><a href="Operation.html#.manageOffer">manageOffer</a></li><li data-type='method'><a href="Operation.html#.operationToObject">operationToObject</a></li><li data-type='method'><a href="Operation.html#.pathPayment">pathPayment</a></li><li data-type='method'><a href="Operation.html#.payment">payment</a></li><li data-type='method'><a href="Operation.html#.setOptions">setOptions</a></li></ul></li><li><a href="OperationCallBuilder.html">OperationCallBuilder</a><ul class='methods'><li data-type='method'><a href="OperationCallBuilder.html#call">call</a></li><li data-type='method'><a href="OperationCallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="OperationCallBuilder.html#forAccount">forAccount</a></li><li data-type='method'><a href="OperationCallBuilder.html#forLedger">forLedger</a></li><li data-type='method'><a href="OperationCallBuilder.html#forTransaction">forTransaction</a></li><li data-type='method'><a href="OperationCallBuilder.html#limit">limit</a></li><li data-type='method'><a href="OperationCallBuilder.html#operation">operation</a></li><li data-type='method'><a href="OperationCallBuilder.html#order">order</a></li><li data-type='method'><a href="OperationCallBuilder.html#stream">stream</a></li></ul></li><li><a href="OrderbookCallBuilder.html">OrderbookCallBuilder</a><ul class='methods'><li data-type='method'><a href="OrderbookCallBuilder.html#trades">trades</a></li></ul></li><li><a href="PathCallBuilder.html">PathCallBuilder</a></li><li><a href="PaymentCallBuilder.html">PaymentCallBuilder</a><ul class='methods'><li data-type='method'><a href="PaymentCallBuilder.html#call">call</a></li><li data-type='method'><a href="PaymentCallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="PaymentCallBuilder.html#forAccount">forAccount</a></li><li data-type='method'><a href="PaymentCallBuilder.html#forLedger">forLedger</a></li><li data-type='method'><a href="PaymentCallBuilder.html#forTransaction">forTransaction</a></li><li data-type='method'><a href="PaymentCallBuilder.html#limit">limit</a></li><li data-type='method'><a href="PaymentCallBuilder.html#order">order</a></li><li data-type='method'><a href="PaymentCallBuilder.html#stream">stream</a></li></ul></li><li><a href="Server.html">Server</a><ul class='methods'><li data-type='method'><a href="Server.html#accounts">accounts</a></li><li data-type='method'><a href="Server.html#effects">effects</a></li><li data-type='method'><a href="Server.html#ledgers">ledgers</a></li><li data-type='method'><a href="Server.html#loadAccount">loadAccount</a></li><li data-type='method'><a href="Server.html#offers">offers</a></li><li data-type='method'><a href="Server.html#operations">operations</a></li><li data-type='method'><a href="Server.html#orderbook">orderbook</a></li><li data-type='method'><a href="Server.html#paths">paths</a></li><li data-type='method'><a href="Server.html#payments">payments</a></li><li data-type='method'><a href="Server.html#submitTransaction">submitTransaction</a></li><li data-type='method'><a href="Server.html#transactions">transactions</a></li></ul></li><li><a href="Transaction.html">Transaction</a><ul class='methods'><li data-type='method'><a href="Transaction.html#hash">hash</a></li><li data-type='method'><a href="Transaction.html#sign">sign</a></li><li data-type='method'><a href="Transaction.html#signatureBase">signatureBase</a></li><li data-type='method'><a href="Transaction.html#toEnvelope">toEnvelope</a></li></ul></li><li><a href="TransactionBuilder.html">TransactionBuilder</a><ul class='methods'><li data-type='method'><a href="TransactionBuilder.html#addMemo">addMemo</a></li><li data-type='method'><a href="TransactionBuilder.html#addOperation">addOperation</a></li><li data-type='method'><a href="TransactionBuilder.html#build">build</a></li></ul></li><li><a href="TransactionCallBuilder.html">TransactionCallBuilder</a><ul class='methods'><li data-type='method'><a href="TransactionCallBuilder.html#call">call</a></li><li data-type='method'><a href="TransactionCallBuilder.html#cursor">cursor</a></li><li data-type='method'><a href="TransactionCallBuilder.html#forAccount">forAccount</a></li><li data-type='method'><a href="TransactionCallBuilder.html#forLedger">forLedger</a></li><li data-type='method'><a href="TransactionCallBuilder.html#limit">limit</a></li><li data-type='method'><a href="TransactionCallBuilder.html#order">order</a></li><li data-type='method'><a href="TransactionCallBuilder.html#stream">stream</a></li><li data-type='method'><a href="TransactionCallBuilder.html#transaction">transaction</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Networks">Networks</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/federation_server.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import axios from 'axios';
import URI from 'URIjs';
import Promise from 'bluebird';
import toml from 'toml';
import {isString, pick} from "lodash";
import {Account} from 'stellar-base';

export class FederationServer {
  /**
   * FederationServer handles a network connection to a
   * [federation server](https://www.stellar.org/developers/learn/concepts/federation.html)
   * instance and exposes an interface for requests to that instance.
   * @constructor
   * @param {string} serverURL The federation server URL (ex. `https://acme.com/federation`). The old method (config object parameter) is **deprecated**.
   * @param {string} domain Domain this server represents
   */
  constructor(serverURL, domain) {
    if (isString(serverURL)) {
      // TODO `domain` regexp
      this.serverURL = URI(serverURL);
      this.domain = domain;
    } else {
      // We leave the old method for compatibility reasons.
      // This will be removed in the next major release.
      if (!serverURL) {
        serverURL = {};
      }
      this.protocol = serverURL.secure ? "https" : "http";
      this.hostname = serverURL.hostname || "localhost";
      this.port = serverURL.port || 80;
      this.path = serverURL.path || '/federation';
      this.domain = serverURL.domain;
      this.serverURL = URI({
        protocol: this.protocol,
        hostname: this.hostname,
        port: this.port,
        path: this.path
      });
    }
  }

  /**
   * This method is a helper method for handling user inputs that contain `destination` value.
   * It accepts two types of values:
   *
   * * For Stellar address (ex. `bob*stellar.org`) it splits Stellar address and then tries to find information about
   * federation server in `stellar.toml` file for a given domain. It returns a `Promise` which resolves if federation
   * server exists and user has been found and rejects in all other cases.
   * * For Account ID (ex. `GB5XVAABEQMY63WTHDQ5RXADGYF345VWMNPTN2GFUDZT57D57ZQTJ7PS`) it returns a `Promise` which
   * resolves if Account ID is valid and rejects in all other cases. Please note that this method does not check
   * if the account actually exists in a ledger.
   *
   * Example:
   * ```js
   * StellarSdk.FederationServer.forAddress('bob*stellar.org')
   *  .then(federationRecord => {
   *    // {
   *    //   account_id: 'GB5XVAABEQMY63WTHDQ5RXADGYF345VWMNPTN2GFUDZT57D57ZQTJ7PS',
   *    //   memo_type: 'id',
   *    //   memo: 100
   *    // }
   *  });
   * ```
   * It returns a `Promise` that will resolve to a JSON object with following fields:
   * * `account_id` - Account ID of the destination,
   * * `memo_type` (optional) - Memo type that needs to be attached to a transaction,
   * * `memo` (optional) - Memo value that needs to be attached to a transaction.
   *
   * The Promise will reject in case of any errors.
   *
   * @see &lt;a href="https://www.stellar.org/developers/learn/concepts/federation.html" target="_blank">Federation doc&lt;/a>
   * @see &lt;a href="https://www.stellar.org/developers/learn/concepts/stellar-toml.html" target="_blank">Stellar.toml doc&lt;/a>
   * @param {string} value Stellar Address (ex. `bob*stellar.org`)
   * @returns {Promise}
   */
  static resolve(value) {
    // Check if `value` is in account ID format
    if (value.indexOf('*') &lt; 0) {
      if (!Account.isValidAccountId(value)) {
        return Promise.reject(new Error('Invalid Account ID'));
      } else {
        return Promise.resolve({account_id: value});
      }
    } else {
      let addressParts = value.split('*');
      let [,domain] = addressParts;

      if (addressParts.length != 2 || !domain) {
        return Promise.reject(new Error('Invalid Stellar address'));
      }
      return FederationServer.createForDomain(domain)
        .then(federationServer => federationServer.resolveAddress(value))
        .then(response => pick(response, ['account_id', 'memo_type', 'memo']));
    }
  }

  /**
   * Creates a `FederationServer` instance based on information from [stellar.toml](https://www.stellar.org/developers/learn/concepts/stellar-toml.html) file for a given domain.
   * Returns a `Promise` that resolves to a `FederationServer` object. If `stellar.toml` file does not exist for a given domain or it does not contain information about a federation server Promise will reject.
   * ```js
   * StellarSdk.FederationServer.createForDomain('acme.com')
   *   .then(federationServer => {
   *     // federationServer.forAddress('bob').then(...)
   *   })
   *   .catch(error => {
   *     // stellar.toml does not exist or it does not contain information about federation server.
   *   });
   * ```
   * @see &lt;a href="https://www.stellar.org/developers/learn/concepts/stellar-toml.html" target="_blank">Stellar.toml doc&lt;/a>
   * @param {string} domain Domain to get federation server for
   * @returns {Promise}
   */
  static createForDomain(domain) {
    return axios.get(`https://www.${domain}/.well-known/stellar.toml`)
      .then(response => {
        let tomlObject = toml.parse(response.data);
        if (!tomlObject.FEDERATION_SERVER) {
          return Promise.reject(new Error('stellar.toml does not contain FEDERATION_SERVER field'));
        }
        return new FederationServer(tomlObject.FEDERATION_SERVER, domain);
      });
  }

  /**
   * Returns a Promise that resolves to federation record if the user was found for a given Stellar address.
   * @see &lt;a href="https://www.stellar.org/developers/learn/concepts/federation.html" target="_blank">Federation doc&lt;/a>
   * @param {string} address Stellar address (ex. `bob*stellar.org`). If `FederationServer` was instantiated with `domain` param only username (ex. `bob`) can be passed.
   * @returns {Promise}
   */
  resolveAddress(address) {
    if (address.indexOf('*') &lt; 0) {
      if (!this.domain) {
        return Promise.reject(new Error('Unknown domain. Make sure `address` contains a domain (ex. `bob*stellar.org`) or pass `domain` parameter when instantiating the server object.'));
      }
      address = `${address}*${this.domain}`;
    }
    let url = this.serverURL.query({type: 'name', q: address});
    return this._sendRequest(url);
  }

  /**
   * Returns a Promise that resolves to federation record if the user was found for a given account ID.
   * @see &lt;a href="https://www.stellar.org/developers/learn/concepts/federation.html" target="_blank">Federation doc&lt;/a>
   * @param {string} accountId Account ID (ex. `GBYNR2QJXLBCBTRN44MRORCMI4YO7FZPFBCNOKTOBCAAFC7KC3LNPRYS`)
   * @returns {Promise}
   */
  resolveAccountId(accountId) {
    let url = this.serverURL.query({type: 'id', q: accountId});
    return this._sendRequest(url);
  }

  /**
   * Returns a Promise that resolves to federation record if the sender of the transaction was found for a given transaction ID.
   * @see &lt;a href="https://www.stellar.org/developers/learn/concepts/federation.html" target="_blank">Federation doc&lt;/a>
   * @param {string} transactionId Transaction ID (ex. `3389e9f0f1a65f19736cacf544c2e825313e8447f569233bb8db39aa607c8889`)
   * @returns {Promise}
   */
  resolveTransactionId(transactionId) {
    let url = this.serverURL.query({type: 'txid', q: transactionId});
    return this._sendRequest(url);
  }

  _sendRequest(url) {
    return axios.get(url.toString())
      .then(response => response.data)
      .catch(function (response) {
        if (response instanceof Error) {
          return Promise.reject(response);
        } else {
          return Promise.reject(response.data);
        }
      });
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.0-dev</a> on Mon Jan 25 2016 23:08:41 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
